version: 2.1

executors:
  ex:
    docker:
      - image: fedora:latest

commands:
  get-deps:
    description: update & get project dependencies / packages
    steps:
    - run: 
        command: sudo dnf update -y
        name: update
    - run:
        command: sudo dnf install -y gcc gcc-c++ cmake make botan2-devel
        name: install deps
    

jobs:
  build:
    executor: ex    
    steps:
    - checkout
    - get-deps
    - run:
        command: |
          cmake -S . -B build
          cmake --build build
        name: build
    - persist_to_workspace: #(6)
        root: .
        paths: build
        
  test:
    executor: ex
    steps:
    - get-deps
    - attach_workspace:
        at: .
    - run:
        command: echo -e "testpw\ntestpw" | build/fastca testhost

workflows:
  build:
    jobs:
    - build
    - test:
        requires:
          - build
  version: 2
